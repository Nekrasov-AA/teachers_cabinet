# Ограничения и защита системы

## 1. Лимиты размера загрузок

### Файлы (src/app/api/upload/route.ts)
- **Максимальный размер файла**: 10 MB
- **Допустимые расширения**: `.xlsx`, `.xls`, `.csv`, `.txt`, `.pdf`, `.doc`, `.docx`
- **Валидация**: Проверяется на фронте и на беке

### Excel файлы (src/lib/excel/parse.ts)
- **Максимальное количество строк**: 2000 строк
- **Максимальное количество колонок**: 100 колонок
- **Максимальная длина строкового значения**: 30,000 символов
- **Максимальный размер объекта строки**: ~100 KB (JSON)

## 2. Валидация данных

### Структура (Schema) - src/lib/excel/validate.ts
- ✅ Колонки не пусты
- ✅ Ключи колонок уникальны
- ✅ Количество колонок <= 100
- ✅ Все метки содержат текст

### Типы данных
Каждому значению в ячейке соответствует один из типов:
- `string` - текст (макс 30,000 символов)
- `number` - числовое значение (конечное)
- `boolean` - true/false
- `date` - дата в ISO формате

**Валидация**: Значения проверяются против указанного типа перед сохранением

### Предпосмотр импорта
- Проверяются первые строки перед полным импортом
- Возвращаются первые 5 ошибок валидации
- Если есть ошибки - импорт отклоняется

## 3. Защита от падения страниц

### Обработка ошибок
Все API endpoints обёрнуты в try-catch блоки:
- **src/app/api/upload/route.ts** - валидация файлов
- **src/app/api/sections/[id]/tables/import/route.ts** - импорт Excel
- **src/app/api/tables/[tableId]/rows/route.ts** - создание строк
- **src/app/api/tables/[tableId]/rows/[rowId]/route.ts** - удаление строк
- **src/app/api/sections/[id]/tables/[tableId]/route.ts** - удаление таблиц

### Ошибки возвращаются
```json
{
  "ok": false,
  "message": "Описание ошибки на русском"
}
```

### Логирование
- Все ошибки логируются в консоль на сервере
- Сохраняются в Audit Log при импорте

## 4. Конкретные проверки

### Загрузка файла (POST /api/upload)
```
✅ Файл выбран
✅ Файл не пуст
✅ Размер <= 10MB
✅ Расширение допустимо
✅ Загрузка в Supabase успешна
```

### Импорт Excel (POST /api/sections/[id]/tables/import)
```
✅ Файл валиден
✅ Excel читается
✅ Лист не пуст
✅ Есть строка заголовков
✅ Количество строк <= 2000
✅ Количество колонок <= 100
✅ Структура колонок валидна
✅ Первые строки данных валидны
✅ Раздел существует
✅ Таблица создана успешно
✅ Строки вставлены успешно
```

Если что-то не прошло - таблица удаляется, данные не сохраняются.

### Создание строки (POST /api/tables/[tableId]/rows)
```
✅ JSON валидный
✅ Поле "row" - объект
✅ Размер строки <= 100KB
✅ Таблица существует
✅ Строка вставлена в БД
```

## 5. Поведение при ошибках

Клиент получает:
1. **HTTP статус** - 400 (невалидный запрос) или 500 (ошибка сервера)
2. **JSON ответ** - сообщение на русском языке
3. **Консоль** - детали ошибки в логах сервера

Страница **не падает**, пользователь видит ошибку и может повторить попытку.

## 6. Примеры обработки

### Пример 1: Файл слишком большой
```json
{
  "ok": false,
  "message": "Файл слишком большой. Максимум: 10MB"
}
// Status: 400
```

### Пример 2: Превышен лимит строк
```json
{
  "ok": false,
  "message": "Превышен лимит строк: 2500 > 2000"
}
// Status: 400
```

### Пример 3: Ошибка типа в колонке
```json
{
  "ok": false,
  "message": "Ошибки в данных: Колонка \"Возраст\" (строка 2): Ожидается число, получено string"
}
// Status: 400
```

## 7. Рекомендации при развертывании

1. **Мониторинг логов** - следить за ошибками в консоли сервера
2. **Audit log** - проверять логи импорта для аудита
3. **Таймауты** - импорт большого файла может занять время (настроено в playwright.config.ts и Next.js)
4. **Размеры** - если нужны большие файлы, увеличить MAX_FILE_SIZE и MAX_ROWS
